<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>TextNow Contacts</title>
  <script type="module" src="/textnow-panel/panel.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Roboto, sans-serif;
      background: var(--primary-background-color, #1c1c1c);
      color: var(--primary-text-color, #fff);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .contact-list {
      display: grid;
      gap: 16px;
    }
    .contact-card {
      background: var(--card-background-color, #2d2d2d);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .contact-info h3 {
      margin: 0 0 8px 0;
      color: var(--primary-color, #03a9f4);
    }
    .contact-info p {
      margin: 0;
      color: var(--secondary-text-color, #aaa);
      font-size: 14px;
    }
    .contact-actions {
      display: flex;
      gap: 8px;
    }
    button {
      background: var(--primary-color, #03a9f4);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      opacity: 0.8;
    }
    button.secondary {
      background: var(--secondary-color, #666);
    }
    button.danger {
      background: var(--error-color, #f44336);
    }
    .add-button {
      background: var(--primary-color, #03a9f4);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
    }
    .dialog {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .dialog.open {
      display: flex;
    }
    .dialog-content {
      background: var(--card-background-color, #2d2d2d);
      border-radius: 8px;
      padding: 24px;
      min-width: 400px;
      max-width: 500px;
    }
    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .dialog-header h2 {
      margin: 0;
    }
    .close-button {
      background: none;
      border: none;
      color: var(--primary-text-color, #fff);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--primary-text-color, #fff);
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--divider-color, #444);
      border-radius: 4px;
      background: var(--input-background-color, #1c1c1c);
      color: var(--primary-text-color, #fff);
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color, #03a9f4);
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 24px;
    }
    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--secondary-text-color, #aaa);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TextNow Contacts</h1>
      <button class="add-button" onclick="showAddDialog()">+ Add Contact</button>
    </div>
    
    <div id="contact-list" class="contact-list">
      <div class="empty-state">Loading contacts...</div>
    </div>
  </div>

  <!-- Add/Edit Dialog -->
  <div id="contact-dialog" class="dialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h2 id="dialog-title">Add Contact</h2>
        <button class="close-button" onclick="closeDialog()">Ã—</button>
      </div>
      <form id="contact-form" onsubmit="saveContact(event)">
        <div class="form-group">
          <label for="contact-name">Name</label>
          <input type="text" id="contact-name" required>
        </div>
        <div class="form-group">
          <label for="contact-phone">Phone Number (10 digits)</label>
          <input type="tel" id="contact-phone" pattern="[0-9]*" maxlength="10" required>
          <small style="color: var(--secondary-text-color, #aaa);">Will be formatted as +1XXXXXXXXXX</small>
        </div>
        <div class="form-actions">
          <button type="button" class="secondary" onclick="closeDialog()">Cancel</button>
          <button type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let contacts = {};
    let editingId = null;
    let entryId = null;

    async function loadContacts() {
      try {
        // Get entry ID from config entries
        const response = await fetch('/api/config/config_entries/entry', {
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const entries = await response.json();
        const textnowEntry = entries.find(e => e.domain === 'textnow');
        
        if (!textnowEntry) {
          document.getElementById('contact-list').innerHTML = 
            '<div class="empty-state">TextNow integration not configured</div>';
          return;
        }

        entryId = textnowEntry.entry_id;
        const configResponse = await fetch(`/api/textnow/config?entry_id=${entryId}`, {
          credentials: 'same-origin'
        });
        if (!configResponse.ok) {
          throw new Error(`HTTP ${configResponse.status}: ${configResponse.statusText}`);
        }
        const data = await configResponse.json();
        contacts = data.contacts || {};
        renderContacts();
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contact-list').innerHTML = 
          `<div class="empty-state">Error loading contacts: ${error.message}</div>`;
      }
    }

    function renderContacts() {
      const list = document.getElementById('contact-list');
      
      if (Object.keys(contacts).length === 0) {
        list.innerHTML = '<div class="empty-state">No contacts added yet. Click "Add Contact" to get started.</div>';
        return;
      }

      list.innerHTML = Object.entries(contacts).map(([id, contact]) => `
        <div class="contact-card">
          <div class="contact-info">
            <h3>${escapeHtml(contact.name)}</h3>
            <p>${escapeHtml(contact.phone)}</p>
          </div>
          <div class="contact-actions">
            <button class="secondary" onclick="editContact('${id}')">Edit</button>
            <button class="danger" onclick="deleteContact('${id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function showAddDialog() {
      editingId = null;
      document.getElementById('dialog-title').textContent = 'Add Contact';
      document.getElementById('contact-name').value = '';
      document.getElementById('contact-phone').value = '';
      document.getElementById('contact-dialog').classList.add('open');
    }

    function editContact(id) {
      editingId = id;
      const contact = contacts[id];
      document.getElementById('dialog-title').textContent = 'Edit Contact';
      document.getElementById('contact-name').value = contact.name;
      document.getElementById('contact-phone').value = contact.phone.replace('+1', '');
      document.getElementById('contact-dialog').classList.add('open');
    }

    function closeDialog() {
      document.getElementById('contact-dialog').classList.remove('open');
      editingId = null;
    }

    async function saveContact(event) {
      event.preventDefault();
      
      const name = document.getElementById('contact-name').value.trim();
      const phone = document.getElementById('contact-phone').value.trim();
      
      if (!name || !phone) {
        alert('Name and phone are required');
        return;
      }

      if (phone.length !== 10 || !/^\d+$/.test(phone)) {
        alert('Phone number must be exactly 10 digits');
        return;
      }

      try {
        const formattedPhone = '+1' + phone;
        let contactId;
        
        if (editingId) {
          contactId = editingId;
        } else {
          contactId = 'contact_' + name.toLowerCase().replace(/\s+/g, '_');
        }

        const response = await fetch('/api/textnow/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            entry_id: entryId,
            action: editingId ? 'update_contact' : 'add_contact',
            contact_id: contactId,
            name: name,
            phone: phone,
          }),
        });

        const result = await response.json();
        if (result.success) {
          closeDialog();
          await loadContacts();
        } else {
          alert(result.error || 'Failed to save contact');
        }
      } catch (error) {
        alert('Error saving contact: ' + error.message);
      }
    }

    async function deleteContact(id) {
      if (!confirm('Delete this contact?')) return;

      try {
        const response = await fetch('/api/textnow/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            entry_id: entryId,
            action: 'delete_contact',
            contact_id: id,
          }),
        });

        const result = await response.json();
        if (result.success) {
          await loadContacts();
        } else {
          alert(result.error || 'Failed to delete contact');
        }
      } catch (error) {
        alert('Error deleting contact: ' + error.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load contacts on page load
    loadContacts();
  </script>
</body>
</html>
