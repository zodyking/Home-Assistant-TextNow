<!DOCTYPE html>
<html>
<head>
  <title>TextNow Manager</title>
  <script src="/frontend_latest/ha.js"></script>
  <style>
    .container { padding: 20px; font-family: var(--primary-font-family); }
    .contact-list { margin: 20px 0; }
    .contact { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--divider-color); }
    button { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    button:hover { background: var(--primary-color-dark); }
    .add-form { margin: 20px 0; }
    input { padding: 8px; margin-right: 10px; border: 1px solid var(--divider-color); border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>TextNow Contacts & Hubs</h1>
    
    <div class="add-form">
      <h3>Add Contact</h3>
      <input id="contact-name" placeholder="Name">
      <input id="contact-phone" placeholder="Phone (10 digits)">
      <button onclick="addContact()">Add</button>
    </div>

    <div id="contacts-list" class="contact-list">
      <h3>Contacts</h3>
      <!-- Populated by JS -->
    </div>

    <div id="hubs-list" class="contact-list">
      <h3>Hubs</h3>
      <!-- Populated by JS -->
    </div>
  </div>

  <script>
    class TextNowPanel extends HTMLElement {
      hassConnected() {
        this.render();
        this.hass.connection.subscribeEvents(() => this.render(), 'textnow_contact_added');
        this.hass.connection.subscribeEvents(() => this.render(), 'textnow_contact_deleted');
      }

      render() {
        const contacts = Object.values(this.hass.states)
          .filter(entity => entity.entity_id.startsWith('sensor.textnow_contact'))
          .map(entity => ({
            id: entity.attributes.friendly_name,
            name: entity.attributes.friendly_name,
            phone: entity.attributes.device_class || 'Unknown'
          }));

        document.getElementById('contacts-list').innerHTML = `
          <h3>Contacts (${contacts.length})</h3>
          ${contacts.map(contact => `
            <div class="contact">
              <span>${contact.name} (${contact.phone})</span>
              <div>
                <button onclick="editContact('${contact.id}')">Edit</button>
                <button onclick="deleteContact('${contact.id}')">Delete</button>
              </div>
            </div>
          `).join('')}
        `;
      }
    }

    customElements.define('textnow-panel', TextNowPanel);

    window.addEventListener('load', () => {
      const panel = document.querySelector('textnow-panel');
      panel.hass = window.hass;
      panel.hassConnected();
    });

    async function addContact() {
      const name = document.getElementById('contact-name').value;
      const phone = document.getElementById('contact-phone').value;
      
      if (!name || !phone) return alert('Name and phone required');
      
      await window.hass.callService('textnow', 'add_contact', {
        name, phone
      });
      
      document.getElementById('contact-name').value = '';
      document.getElementById('contact-phone').value = '';
    }

    async function deleteContact(contactId) {
      if (confirm(`Delete ${contactId}?`)) {
        await window.hass.callService('textnow', 'delete_contact', {
          contact_id: contactId
        });
      }
    }

    function editContact(contactId) {
      const newName = prompt('New name:');
      const newPhone = prompt('New phone:');
      if (newName && newPhone) {
        window.hass.callService('textnow', 'edit_contact', {
          contact_id: contactId,
          name: newName,
          phone: newPhone
        });
      }
    }
  </script>
</body>
</html>
